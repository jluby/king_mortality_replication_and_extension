---
title: Replication of 'Systematic Bias and Nontransparency in US Social Security Administration
  Forecasts'
author: "Jack Luby"
date: "4/5/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r include = FALSE, cache = FALSE}
# load libraries
library(knitr)
library(ggplot2)
library(reshape2)
library(grid)
library(gridExtra)
library(xtable)
library(haven)
library(tidyverse)
library(purrr)

##### set custom_font to FALSE unless have extrafont library and Minion Pro font installed
custom_font <- FALSE

# code for using Minion Pro font for figures
if(custom_font){
	library(extrafont)
	if("Minion Pro" %in% fonts()==FALSE){
		warning("No Minion Pro font")
		theme_set(theme_bw())
		ff <- ""
	} else {
		theme_set(theme_bw(base_family="Minion Pro"))
		ff <- "Minion Pro"
	}
} else {
	theme_set(theme_bw())
	ff <- ""
}

# set global chunk options
options(replace.assign=TRUE,width=50)
opts_chunk$set(fig.path='figures/systematic/graphics-', fig.align='center', cache=FALSE, fig.show='hold', warning=FALSE, message=FALSE, results='asis')

# allow custom plots
knit_hooks$set(custom.plot = hook_plot_custom)

# Create figures subdirectory if it doesn't exist
if(!file.exists("figures")){
	dir.create(file.path("figures"))
}

# Create figures subdirectory if it doesn't exist
if(!file.exists("figures/systematic")){
	dir.create(file.path("figures/systematic"))
}
```


```{r inclue = FALSE, cache = FALSE}
### LOAD DATA
# Financial and demographic forecasts and errors 
tf.balance.pred <- read_dta("systematic_bias_dataverse_files/data/tf_balance_pred.dta")
  colnames(tf.balance.pred) <- map_chr(1:ncol(tf.balance.pred), function(x) attr(tf.balance.pred[[x]], "label"))
tf.ratio.pred <- read_dta("systematic_bias_dataverse_files/data/tf_ratio_pred.dta")
  colnames(tf.ratio.pred) <- map_chr(1:ncol(tf.ratio.pred), function(x) attr(tf.ratio.pred[[x]], "label"))
ex.ssa <- read_dta("systematic_bias_dataverse_files/data/ex_ssa.dta")
  colnames(ex.ssa) <- map_chr(1:ncol(ex.ssa), function(x) attr(ex.ssa[[x]], "label"))
tfr.ssa <- read_dta("systematic_bias_dataverse_files/data/tfr_ssa.dta")
  colnames(tfr.ssa) <- map_chr(1:ncol(tfr.ssa), function(x) attr(tfr.ssa[[x]], "label"))

# Observed demographic data (life expectancy)
obs.ex <- read_dta("systematic_bias_dataverse_files/data/observed/obs_ex.dta")
  colnames(obs.ex) <- map_chr(1:ncol(obs.ex), function(x) attr(obs.ex[[x]], "label"))

# Unexpected beneficiaries from underestimating life expectancy
ub <- read_dta("systematic_bias_dataverse_files/data/unexpect_benif.dta")
  colnames(ub) <- map_chr(1:ncol(ub), function(x) attr(ub[[x]], "label"))
expend_obs <- read_dta("systematic_bias_dataverse_files/data/ssa_expend.dta")
  colnames(expend_obs) <- map_chr(1:ncol(expend_obs), function(x) attr(expend_obs[[x]], "label"))
expend_forecasts <- read_dta("systematic_bias_dataverse_files/data/ssa_expend_forecasts.dta")
  colnames(expend_forecasts) <- map_chr(1:ncol(expend_forecasts), function(x) attr(expend_forecasts[[x]], "label"))

obs.ex <- obs.ex %>%
  mutate(sex = case_when(sex == 2 ~ "Male",
                         sex == 1 ~ "Female"))

# We will only look at demographic forecasts made for 1985 to 2010, every 5 years
main_years <- seq(1985,2010,5)
ex.use <- ex.ssa[ex.ssa$forecast.year %in% main_years,]
# get TRs that make these forecasts
TRs <- unique(ex.use$TR)
```


\title{Systematic Bias and Nontransparency in US Social Security Administration Forecasts\\Replication of Figures}
\author{Konstantin Kashin, Gary King, and Samir Soneji}
\date{March 2015}
\maketitle

\tableofcontents
\newpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% DEMOGRAPHY - Life Expectancy %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Demographic Forecasts: Life Expectancy}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Observed data         %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Observed Life Expectancy}

\begin{figure}[h!]
\caption{Observed Period Life Expectancy. As
    described in the text, ``period life expectancy'' for a year is a
    single-number summary of all the age-specific mortality rates for
    that same year and is interpreted as the average number of years a
    person could expect to live if he or she experienced the mortality
    rates of a given year over the course of their life.}\label{observed-bw}


```{r observed-bw,out.width='\\linewidth',custom.plot=TRUE, fig.keep='all', fig.ext='pdf',echo=FALSE}
# data frame of observed LE data (from HMD)
#obs.df <- melt(obs.ex[as.character(TRs)])
obs.df <- obs.ex %>% select(year, sex, age, ex)
colnames(obs.df) <- c("year","sex","age","ex")
obs.df$type <- "Male Life Expectancy at Birth"
obs.df[obs.df$age==65 & obs.df$sex=="Male",]$type <- "Male Life Expectancy at 65"
obs.df[obs.df$age==0 & obs.df$sex=="Female",]$type <- "Female Life Expectancy at Birth"
obs.df[obs.df$age==65 & obs.df$sex=="Female",]$type <- "Female Life Expectancy at 65"

# reorder factors
obs.df$type_order <- 1
obs.df$type_order[obs.df$type=="Female Life Expectancy at Birth"] <- 2
obs.df$type_order[obs.df$type=="Male Life Expectancy at 65"] <- 3
obs.df$type_order[obs.df$type=="Female Life Expectancy at 65"] <- 4
obs.df$type <- reorder(obs.df$type, obs.df$type_order)

# Strangely, the dataset has two observations for each group for each year. These values differ and, further, are NA for several years. I don't know why. I think the melt() command above is how they got rid of these observations and got only years 1982- but I didn't get that to work
obs.df <- obs.df[1:312,]
obs.df <- obs.df %>% 
  filter(year >= 1982)

obs.plot <- ggplot(data=obs.df, aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy")

ggsave(filename='figures/systematic/graphics-observed-bw-1.pdf', plot=obs.plot, height=8, width=8)
```
\end{figure}


```{r}
obs.df.future <- obs.df %>% 
  add_row(year = 2011:2020, sex = "Male", age = 0, type = "Male Life Expectancy at Birth", type_order = 1, .after = 29) %>% 
  add_row(year = 2011:2020, sex = "Female", age = 0, type = "Female Life Expectancy at Birth", type_order = 2, .after = 68) %>% 
  add_row(year = 2011:2020, sex = "Male", age = 65, type = "Male Life Expectancy at 65", type_order = 3, .after = 107) %>% 
  add_row(year = 2011:2020, sex = "Female", age = 65, type = "Female Life Expectancy at 65", type_order = 4, .after = 146)
```


```{r linear_fits}
male_birth <- obs.df.future %>% 
  filter(type == "Male Life Expectancy at Birth")
  
male_birth_lm <- lm(
    ex ~ year,
    data = male_birth)

male_birth_preds <- predict(
    male_birth_lm,
    newdata = male_birth,
    interval = "confidence"
)

female_birth <- obs.df.future %>% 
  filter(type == "Female Life Expectancy at Birth")
  
female_birth_lm <- lm(
    ex ~ year,
    data = female_birth)

female_birth_preds <- predict(
    female_birth_lm,
    newdata = female_birth,
    interval = "confidence"
)

male_65 <- obs.df.future %>% 
  filter(type == "Male Life Expectancy at 65")
  
male_65_lm <- lm(
    ex ~ year,
    data = male_65)

male_65_preds <- predict(
    male_65_lm,
    newdata = male_65,
    interval = "confidence"
)

female_65 <- obs.df.future %>% 
  filter(type == "Female Life Expectancy at 65")
  
female_65_lm <- lm(
    ex ~ year,
    data = female_65)

female_65_preds <- predict(
    female_65_lm,
    newdata = female_65,
    interval = "confidence"
)

linear_preds <- rbind(male_birth_preds, female_birth_preds, male_65_preds, female_65_preds)

obs.df.future <- bind_cols(obs.df.future, as.data.frame(linear_preds))

obs.df.simple.plots <- obs.df.future %>% 
  filter(year <= 2010)

obs.plot.reg <- ggplot(data=obs.df.simple.plots, aes(x=year, y=ex-fit)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Observed Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy")

obs.plot.linear.pred <- ggplot(data=obs.df.simple.plots, aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Observed Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy") + geom_line(aes(y=fit), color = "red")

ggsave(filename='figures/systematic/graphics-observed-regularized-bw-1.pdf', plot=obs.plot.reg, height=8, width=8)
ggsave(filename='figures/systematic/graphics-observed-linear_pred-bw-1.pdf', plot=obs.plot.linear.pred, height=8, width=8)
```

```{r prophet}
library(prophet)
library(lubridate)

obs.df.future.prophet <- obs.df

colnames(obs.df.future.prophet)[1] <- "ds"
colnames(obs.df.future.prophet)[4] <- "y"

obs.df.future.prophet$ds <- paste0(obs.df.future.prophet$ds, "/1/1", sep = "")

obs.df.future.prophet <- obs.df.future.prophet %>% 
  mutate(ds = as.Date(ds))


prophet_male_birth <- obs.df.future.prophet %>%
  filter(type == "Male Life Expectancy at Birth") %>% 
  prophet()
future_male_birth <- make_future_dataframe(prophet_male_birth, periods = 10, freq = "year") 
forecast_male_birth <- predict(prophet_male_birth, future_male_birth) %>% 
  mutate(type = "Male Life Expectancy at Birth")


prophet_female_birth <- obs.df.future.prophet %>%
  filter(type == "Female Life Expectancy at Birth") %>% 
  prophet()
future_female_birth <- make_future_dataframe(prophet_female_birth, periods = 10, freq = "year") 
forecast_female_birth <- predict(prophet_female_birth, future_female_birth) %>% 
  mutate(type = "Female Life Expectancy at Birth")


prophet_male_65 <- obs.df.future.prophet %>%
  filter(type == "Male Life Expectancy at 65") %>% 
  prophet()
future_male_65 <- make_future_dataframe(prophet_male_65, periods = 10, freq = "year") 
forecast_male_65 <- predict(prophet_male_65, future_male_65) %>% 
  mutate(type = "Male Life Expectancy at 65")


prophet_female_65 <- obs.df.future.prophet %>%
  filter(type == "Female Life Expectancy at 65") %>% 
  prophet()
future_female_65 <- make_future_dataframe(prophet_female_65, periods = 10, freq = "year") 
forecast_female_65 <- predict(prophet_female_65, future_female_65) %>% 
  mutate(type = "Female Life Expectancy at 65")

forecast <- rbind(forecast_male_birth, forecast_female_birth, forecast_male_65, forecast_female_65)

forecast <- forecast %>% 
  select(yhat, yhat_lower, yhat_upper)

obs.df.future <- bind_cols(obs.df.future, forecast)
```

```{r arima_fit}
library(forecast)

male_birth_fit <- auto.arima(male_birth$ex[1:29])
male_birth_arima <- as.data.frame(forecast(male_birth_fit, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_birth_arima <- male_birth_arima %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

female_birth_fit <- auto.arima(female_birth$ex[1:29])
female_birth_arima <- as.data.frame(forecast(female_birth_fit, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_birth_arima <- female_birth_arima %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

male_65_fit <- auto.arima(male_65$ex[1:29])
male_65_arima <- as.data.frame(forecast(male_65_fit, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_65_arima <- male_65_arima %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

female_65_fit <- auto.arima(female_65$ex[1:29])
female_65_arima <- as.data.frame(forecast(female_65_fit, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_65_arima <- female_65_arima %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

arima_forecasts <- rbind(male_birth_arima, female_birth_arima, male_65_arima, female_65_arima)
colnames(arima_forecasts) <- c('point_arima', 'lo95_arima', 'hi95_arima')

obs.df.future <- bind_cols(obs.df.future,arima_forecasts)
```

```{r ets_fit}
male_birth_fit_ets <- ets(male_birth$ex[1:29])
male_birth_ets <- as.data.frame(forecast(male_birth_fit_ets, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_birth_ets <- male_birth_ets %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

female_birth_fit_ets <- ets(female_birth$ex[1:29])
female_birth_ets <- as.data.frame(forecast(female_birth_fit_ets, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_birth_ets <- female_birth_ets %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

male_65_fit_ets <- ets(male_65$ex[1:29])
male_65_ets <- as.data.frame(forecast(male_65_fit_ets, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_65_ets <- male_65_ets %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

female_65_fit_ets <- ets(female_65$ex[1:29])
female_65_ets <- as.data.frame(forecast(female_65_fit_ets, h = 10)) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_65_ets <- female_65_ets %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

ets_forecasts <- rbind(male_birth_ets, female_birth_ets, male_65_ets, female_65_ets)
colnames(ets_forecasts) <- c('point_ets', 'lo95_ets', 'hi95_ets')

obs.df.future <- bind_cols(obs.df.future, ets_forecasts)
```

```{r lag_select}
library(readr)
library(dplyr)
smoking_and_obesity <- read_rds("smoking_and_obesity.rds")

smoke_obese_projections <- smoking_and_obesity %>% 
  filter(year %in% 1982:2017) %>% 
  add_row(year = 2018:2020, type_order = 1, .after=36) %>% 
  add_row(year = 2018:2020, type_order = 2, .after=75) %>% 
  add_row(year = 2018:2020, type_order = 3, .after=114) %>% 
  add_row(year = 2018:2020, type_order = 4, .after=153)

smoke_obese_bind <- smoke_obese_projections %>% 
  select(smoke_rate, obesity_rate)

obs.df.future <- bind_cols(obs.df.future, smoke_obese_bind)

# Attempted to use this to solve lag problem but did not have a good time.
# I think it's best to just use the base values to keep things simple.

# lag_select_df <- obs.df %>% 
  # select(ex)

# exogen_all_women = smoke_obese_use[1:29,] %>% 
  # dplyr::select(smoke_rate, obesity_rate)

# library(vars)
# lag_select_df[1:29,] %>% 
  # VARselect(lag.max = 10, exogen = exogen_all_women)
```

```{r smoke_and_obese_projections}
men_smoke <- smoke_obese_projections %>% 
  filter(type_order == 1)
women_smoke <- smoke_obese_projections %>% 
  filter(type_order == 2)
men_65_smoke <- smoke_obese_projections %>% 
  filter(type_order == 3)
women_65_smoke <- smoke_obese_projections %>% 
  filter(type_order == 4)

male_birth_smoke_ets <- ets(men_smoke$smoke_rate[1:29])
men_smoke[30:39,2] <- as.data.frame(forecast(male_birth_smoke_ets, h = 10))[,1]

female_birth_smoke_ets <- ets(women_smoke$smoke_rate[1:29])
women_smoke[30:39,2] <- as.data.frame(forecast(female_birth_smoke_ets, h = 10))[,1]

male_65_smoke_ets <- ets(men_65_smoke$smoke_rate[1:29])
men_65_smoke[30:39,2] <- as.data.frame(forecast(male_65_smoke_ets, h = 10))[,1]

female_65_smoke_ets <- ets(women_65_smoke$smoke_rate[1:29])
women_65_smoke[30:39,2] <- as.data.frame(forecast(female_65_smoke_ets, h = 10))[,1]

male_birth_obese_ets <- ets(men_smoke$obesity_rate[1:29])
men_smoke[30:39,3] <- as.data.frame(forecast(male_birth_obese_ets, h = 10))[,1]

female_birth_obese_ets <- ets(women_smoke$obesity_rate[1:29])
women_smoke[30:39,3] <- as.data.frame(forecast(female_birth_obese_ets, h = 10))[,1]

male_65_obese_ets <- ets(men_65_smoke$obesity_rate[1:29])
men_65_smoke[30:39,3] <- as.data.frame(forecast(male_65_obese_ets, h = 10))[,1]

female_65_obese_ets <- ets(women_65_smoke$obesity_rate[1:29])
women_65_smoke[30:39,3] <- as.data.frame(forecast(female_65_obese_ets, h = 10))[,1]

men_smoke <- as.matrix(men_smoke)
women_smoke <- as.matrix(women_smoke)
men_65_smoke <- as.matrix(men_65_smoke)
women_65_smoke <- as.matrix(women_65_smoke)

smoke_obese_projections_filled <- as.data.frame(rbind(men_smoke[,2:3], women_smoke[,2:3], men_65_smoke[,2:3], women_65_smoke[,2:3]))
```

```{r arima_xreg}
male_birth_fit <- auto.arima(male_birth$ex[1:29], xreg=men_smoke[1:29,2:3])
male_birth_arima_xreg <- as.data.frame(forecast(male_birth_fit, h = 10, xreg=men_smoke[30:39,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_birth_arima_xreg <- male_birth_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

female_birth_fit <- auto.arima(female_birth$ex[1:29], xreg=women_smoke[1:29,2:3])
female_birth_arima_xreg <- as.data.frame(forecast(female_birth_fit, h = 10, xreg=women_smoke[30:39,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_birth_arima_xreg <- female_birth_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

male_65_fit <- auto.arima(male_65$ex[1:29], xreg=men_65_smoke[1:29,2:3])
male_65_arima_xreg <- as.data.frame(forecast(male_65_fit, h = 10, xreg=men_65_smoke[30:39,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_65_arima_xreg <- male_65_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

female_65_fit <- auto.arima(female_65$ex[1:29], xreg=women_65_smoke[1:29,2:3])
female_65_arima_xreg <- as.data.frame(forecast(female_65_fit, h = 10, xreg=women_65_smoke[30:39,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_65_arima_xreg <- female_65_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 29), .before = 1)

arima_forecasts_xreg <- rbind(male_birth_arima_xreg, female_birth_arima_xreg, male_65_arima_xreg, female_65_arima_xreg)
colnames(arima_forecasts_xreg) <- c('point_arima_xreg', 'lo95_arima_xreg', 'hi95_arima_xreg')

obs.df.future <- bind_cols(obs.df.future,arima_forecasts_xreg)
```

```{r add_new_data}
post_2010_data <- read_csv('post_2010_data.csv')[1:40, 1:6]

post_2010_data_bind <- post_2010_data %>% 
  add_row(year = 1982:2010, type_order = 1, .before = 1) %>% 
  add_row(year = 1982:2010, type_order = 2, .before = 40) %>% 
  add_row(year = 1982:2010, type_order = 3, .before = 79) %>% 
  add_row(year = 1982:2010, type_order = 4, .before = 118)

obs.df.future <- bind_cols(obs.df.future, post_2010_data_bind)
```

```{r linear_future_plots}
obs.plot.with.future <- ggplot(data=obs.df.future, aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy with Linear Fit") + geom_line(aes(y=fit), color = "red")

obs.df.future.preds.only <- obs.df.future %>% 
   mutate(fit = ifelse(year <= 2010, NA, fit),
          lwr = ifelse(year <= 2010, NA, lwr),
          upr = ifelse(year <= 2010, NA, upr))

obs.plot.future.preds.only <- obs.df.future.preds.only %>% 
  #filter(type_order == 2) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Performance of Simple Linear Model") + geom_line(aes(y=fit), color = "lightseagreen") + geom_ribbon(aes(ymin=lwr, ymax=upr), alpha=0.1, fill = "lightseagreen") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-linear_pred_past_and_future-bw-1.pdf', plot=obs.plot.with.future, height=8, width=8)
ggsave(filename='figures/systematic/graphics-linear_pred_future-bw-1.pdf', plot=obs.plot.future.preds.only, height=8, width=8)
```

```{r prophet_plots}
obs.plot.prophet.fit <- obs.df.future %>% 
  #filter(year <= 2010) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy") + geom_line(aes(y=yhat, color = "red"))

ggsave(filename='figures/systematic/graphics-prophet-fit-bw-1.pdf', plot=obs.plot.prophet.fit, height=8, width=8)

obs.df.future <- obs.df.future %>% 
  mutate(yhat = ifelse(year > 2010, yhat, NA),
         yhat_lower = ifelse(year > 2010, yhat_lower, NA),
         yhat_upper = ifelse(year > 2010, yhat_upper, NA))

obs.plot.prophet <- ggplot(data=obs.df.future, aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy") + geom_line(aes(y=yhat), color = "deepskyblue2") + geom_ribbon(aes(ymin=yhat_lower, ymax=yhat_upper), alpha=0.1, fill = "deepskyblue2") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-prophet_pred_future-bw-1.pdf', plot=obs.plot.prophet, height=8, width=8)
```

```{r ets_plot}
obs.plot.ets <- obs.df.future %>% 
  #filter(type_order == 2) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy") + geom_line(aes(y=point_ets), color = "palegreen4") + geom_ribbon(aes(ymin=lo95_ets, ymax=hi95_ets), alpha=0.1, fill = "palegreen4") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-ets_pred_future-bw-1.pdf', plot=obs.plot.ets, height=8, width=8)
```

```{r arima_plot}
obs.plot.arima <- obs.df.future %>% 
  #filter(type_order == 2) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy") + geom_line(aes(y=point_arima), color = "red4") + geom_ribbon(aes(ymin=lo95_arima, ymax=hi95_arima), alpha=0.1, fill = "red4") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-arima_pred_future-bw-1.pdf', plot=obs.plot.arima, height=8, width=8)
```

```{r arima_plot_xreg}
obs.plot.arima.xreg <- obs.df.future %>% 
  #filter(type_order == 2) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Performance of Arima Model with External Regressors") + geom_line(aes(y=point_arima_xreg), color = "darkorange3") + geom_ribbon(aes(ymin=lo95_arima_xreg, ymax=hi95_arima_xreg), alpha=0.1, fill = "darkorange3") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-arima_xreg_pred_future-bw-1.pdf', plot=obs.plot.arima.xreg, height=8, width=8)
```

```{r ssa_pred_plot}
obs.plot.ssa <- obs.df.future %>% 
  #filter(type_order == 2) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Performance of SSA Forecasts") + geom_line(aes(y=ssa_projection), color = "gray48") + geom_ribbon(aes(ymin=lower_bound, ymax=upper_bound), alpha=0.1, fill = "gray48") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-ssa_pred_future-bw-1.pdf', plot=obs.plot.ssa, height=7, width=8)
```

```{r all_preds_all_data}
obs.plots.all <- obs.df.future %>%
  mutate(fit = ifelse(year <= 2010, NA, fit)) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("No One Model Dominates, but SSA Forecasts Lag Below") + geom_line(aes(y=fit), color = "lightseagreen") + geom_line(aes(y=yhat), color = "deepskyblue2") + geom_line(aes(y=point_ets), color = "palegreen4") + geom_line(aes(y=point_arima), color = "red4") + geom_line(aes(y=point_arima_xreg), color = "darkorange3") + geom_line(aes(y=ssa_projection), color = "gray48") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-pred_all-bw-1.pdf', plot=obs.plots.all, height=8, width=8)
```

```{r all_preds_just_preds}
obs.plots.all.preds <- obs.df.future %>%
  mutate(fit = ifelse(year <= 2010, NA, fit)) %>% 
  filter(year > 2010,
         year < 2018) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous(NULL) + facet_wrap(~type, nrow=3, ncol=2, scales="free") + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle(" ") + geom_line(aes(y=fit), color = "lightseagreen") + geom_line(aes(y=yhat), color = "deepskyblue2") + geom_line(aes(y=point_ets), color = "palegreen4") + geom_line(aes(y=point_arima), color = "red4") + geom_line(aes(y=point_arima_xreg), color = "darkorange3") + geom_line(aes(y=ssa_projection), color = "gray48") + geom_point(aes(y = observed))

ggsave(filename='figures/systematic/graphics-pred_all_future-bw-1.pdf', plot=obs.plots.all.preds, height=8, width=8)
```

```{r model_fit_tables}
library(dplyr)
library(kableExtra)
rsq <- function(x, y) cor(x, y) ^ 2

performance_2010_2015 <- obs.df.future %>% 
  filter(year %in% 2011:2015) %>% 
  group_by(type) %>% 
  summarize(ssa = mean((observed - ssa_projection) ^ 2),
            linear = mean((observed - fit) ^ 2),
            prophet = mean((observed - yhat) ^ 2),
            ets = mean((observed - point_ets) ^ 2),
            arima = mean((observed - point_arima) ^2),
            arima_xreg = mean((observed - point_arima_xreg) ^2)) %>% 
  kable(format = 'latex') %>% 
  save_kable('figures/systematic/performance_2010_2015.pdf')
performance_2010_2015


performance_2010_2017 <- obs.df.future %>% 
  filter(year %in% 2011:2017) %>% 
  group_by(type) %>% 
  summarize(ssa = mean((observed - ssa_projection) ^ 2),
            linear = mean((observed - fit) ^ 2),
            prophet = mean((observed - yhat) ^ 2),
            ets = mean((observed - point_ets) ^ 2),
            arima = mean((observed - point_arima) ^2),
            arima_xreg = mean((observed - point_arima_xreg) ^2)) %>% 
  kable(format = 'latex') %>% 
  save_kable('figures/systematic/performance_2010_2017.pdf')
performance_2010_2017
```

```{r linear_refit_2005_2010}
male_birth <- obs.df.future %>% 
  filter(type == "Male Life Expectancy at Birth") %>% 
  filter(year <= 2010)
male_birth[25:29, 4] <- NA
male_birth <- male_birth[,1:6]
  
male_birth_lm <- lm(
    ex ~ year,
    data = male_birth)

male_birth_preds <- predict(
    male_birth_lm,
    newdata = male_birth,
    interval = "confidence"
)

female_birth <- obs.df.future %>% 
  filter(type == "Female Life Expectancy at Birth") %>% 
  filter(year <= 2010)
male_birth[25:29, 4] <- NA
male_birth <- male_birth[,1:6]
  
female_birth_lm <- lm(
    ex ~ year,
    data = female_birth)

female_birth_preds <- predict(
    female_birth_lm,
    newdata = female_birth,
    interval = "confidence"
)

male_65 <- obs.df.future %>% 
  filter(type == "Male Life Expectancy at 65") %>% 
  filter(year <= 2010)
male_birth[25:29, 4] <- NA
male_birth <- male_birth[,1:6]
  
male_65_lm <- lm(
    ex ~ year,
    data = male_65)

male_65_preds <- predict(
    male_65_lm,
    newdata = male_65,
    interval = "confidence"
)

female_65 <- obs.df.future %>% 
  filter(type == "Female Life Expectancy at 65") %>% 
  filter(year <= 2010)
male_birth[25:29, 4] <- NA
male_birth <- male_birth[,1:6]
  
female_65_lm <- lm(
    ex ~ year,
    data = female_65)

female_65_preds <- predict(
    female_65_lm,
    newdata = female_65,
    interval = "confidence"
)

linear_preds <- as.data.frame(rbind(male_birth_preds, female_birth_preds, male_65_preds, female_65_preds))
colnames(linear_preds) <- c("fit", "lwr", "upr")

obs.df_2005 <- obs.df.future %>% 
  filter(year <= 2010) %>% 
  mutate(ex = ifelse(year > 2005, NA, ex)) %>% 
  select(year, sex, age, ex, type, type_order)

obs.df_2005 <- bind_cols(obs.df_2005, linear_preds)
```

```{r smoke_and_obese_projections_2005}
men_smoke <- smoke_obese_projections %>% 
  filter(type_order == 1) %>% 
  filter(year <= 2010)
women_smoke <- smoke_obese_projections %>% 
  filter(type_order == 2) %>% 
  filter(year <= 2010)
men_65_smoke <- smoke_obese_projections %>% 
  filter(type_order == 3) %>% 
  filter(year <= 2010)
women_65_smoke <- smoke_obese_projections %>% 
  filter(type_order == 4) %>% 
  filter(year <= 2010)

male_birth_smoke_ets <- ets(men_smoke$smoke_rate[1:24])
men_smoke[25:29,2] <- as.data.frame(forecast(male_birth_smoke_ets, h = 5))[,1]

female_birth_smoke_ets <- ets(women_smoke$smoke_rate[1:24])
women_smoke[25:29,2] <- as.data.frame(forecast(female_birth_smoke_ets, h = 5))[,1]

male_65_smoke_ets <- ets(men_65_smoke$smoke_rate[1:24])
men_65_smoke[25:29,2] <- as.data.frame(forecast(male_65_smoke_ets, h = 5))[,1]

female_65_smoke_ets <- ets(women_65_smoke$smoke_rate[1:24])
women_65_smoke[25:29,2] <- as.data.frame(forecast(female_65_smoke_ets, h = 5))[,1]

male_birth_obese_ets <- ets(men_smoke$obesity_rate[1:24])
men_smoke[25:29,3] <- as.data.frame(forecast(male_birth_obese_ets, h = 5))[,1]

female_birth_obese_ets <- ets(women_smoke$obesity_rate[1:24])
women_smoke[25:29,3] <- as.data.frame(forecast(female_birth_obese_ets, h = 5))[,1]

male_65_obese_ets <- ets(men_65_smoke$obesity_rate[1:24])
men_65_smoke[25:29,3] <- as.data.frame(forecast(male_65_obese_ets, h = 5))[,1]

female_65_obese_ets <- ets(women_65_smoke$obesity_rate[1:24])
women_65_smoke[25:29,3] <- as.data.frame(forecast(female_65_obese_ets, h = 5))[,1]

men_smoke <- as.matrix(men_smoke)
women_smoke <- as.matrix(women_smoke)
men_65_smoke <- as.matrix(men_65_smoke)
women_65_smoke <- as.matrix(women_65_smoke)

smoke_obese_projections_filled <- as.data.frame(rbind(men_smoke[,2:3], women_smoke[,2:3], men_65_smoke[,2:3], women_65_smoke[,2:3]))
```

```{r arima_xreg_2005_2010}
male_birth_fit <- auto.arima(male_birth$ex[1:24], xreg=men_smoke[1:24,2:3])
male_birth_arima_xreg <- as.data.frame(forecast(male_birth_fit, h = 5, xreg=men_smoke[25:29,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_birth_arima_xreg <- male_birth_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 24), .before = 1)

female_birth_fit <- auto.arima(female_birth$ex[1:24], xreg=women_smoke[1:24,2:3])
female_birth_arima_xreg <- as.data.frame(forecast(female_birth_fit, h = 5, xreg=women_smoke[25:29,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_birth_arima_xreg <- female_birth_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 24), .before = 1)

male_65_fit <- auto.arima(male_65$ex[1:24], xreg=men_65_smoke[1:24,2:3])
male_65_arima_xreg <- as.data.frame(forecast(male_65_fit, h = 5, xreg=men_65_smoke[25:29,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_65_arima_xreg <- male_65_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 24), .before = 1)

female_65_fit <- auto.arima(female_65$ex[1:24], xreg=women_65_smoke[1:24,2:3])
female_65_arima_xreg <- as.data.frame(forecast(female_65_fit, h = 5, xreg=women_65_smoke[25:29,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_65_arima_xreg <- female_65_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 24), .before = 1)

arima_forecasts_xreg <- rbind(male_birth_arima_xreg, female_birth_arima_xreg, male_65_arima_xreg, female_65_arima_xreg)
colnames(arima_forecasts_xreg) <- c('point_arima_xreg', 'lo95_arima_xreg', 'hi95_arima_xreg')

obs.df_2005 <- bind_cols(obs.df_2005,arima_forecasts_xreg)
```

```{r add_observed_2005}
post_2005_observed <- obs.df.future %>%
  select(year, ex) %>% 
  filter(year %in% 2006:2010) %>% 
  add_row(year = 1982:2005, .before = 1) %>% 
  add_row(year = 1982:2005, .before = 30) %>% 
  add_row(year = 1982:2005, .before = 59) %>% 
  add_row(year = 1982:2005, .before = 88) %>% 
  select(ex)
colnames(post_2005_observed) <- "observed"

obs.df_2005 <- bind_cols(obs.df_2005, post_2005_observed)

ssa_projections_2010 <- read_csv('2006_trustees_report_projections.csv')[1:20,1:5] %>% 
  add_row(year = 1982:2005, type_order = 1, .before = 1) %>% 
  add_row(year = 1982:2005, type_order = 2, .before = 30) %>% 
  add_row(year = 1982:2005, type_order = 3, .before = 59) %>% 
  add_row(year = 1982:2005, type_order = 4, .before = 88) %>% 
  select(ssa_projection, lower_bound, upper_bound)

obs.df_2005 <- bind_cols(obs.df_2005, ssa_projections_2010)
```


```{r linear_refit_2000_2005}
male_birth <- obs.df.future %>% 
  filter(type == "Male Life Expectancy at Birth") %>% 
  filter(year <= 2005)
male_birth[20:24, 4] <- NA
male_birth <- male_birth[,1:6]
  
male_birth_lm <- lm(
    ex ~ year,
    data = male_birth)

male_birth_preds <- predict(
    male_birth_lm,
    newdata = male_birth,
    interval = "confidence"
)

female_birth <- obs.df.future %>% 
  filter(type == "Female Life Expectancy at Birth") %>% 
  filter(year <= 2005)
male_birth[20:24, 4] <- NA
male_birth <- male_birth[,1:6]
  
female_birth_lm <- lm(
    ex ~ year,
    data = female_birth)

female_birth_preds <- predict(
    female_birth_lm,
    newdata = female_birth,
    interval = "confidence"
)

male_65 <- obs.df.future %>% 
  filter(type == "Male Life Expectancy at 65") %>% 
  filter(year <= 2005)
male_birth[20:24, 4] <- NA
male_birth <- male_birth[,1:6]
  
male_65_lm <- lm(
    ex ~ year,
    data = male_65)

male_65_preds <- predict(
    male_65_lm,
    newdata = male_65,
    interval = "confidence"
)

female_65 <- obs.df.future %>% 
  filter(type == "Female Life Expectancy at 65") %>% 
  filter(year <= 2005)
male_birth[20:24, 4] <- NA
male_birth <- male_birth[,1:6]
  
female_65_lm <- lm(
    ex ~ year,
    data = female_65)

female_65_preds <- predict(
    female_65_lm,
    newdata = female_65,
    interval = "confidence"
)

linear_preds <- as.data.frame(rbind(male_birth_preds, female_birth_preds, male_65_preds, female_65_preds))
colnames(linear_preds) <- c("fit", "lwr", "upr")

obs.df_2000 <- obs.df.future %>% 
  filter(year <= 2005) %>% 
  mutate(ex = ifelse(year > 2000, NA, ex)) %>% 
  select(year, sex, age, ex, type, type_order)

obs.df_2000 <- bind_cols(obs.df_2000, linear_preds)
```

```{r smoke_and_obese_projections_2000}
men_smoke <- smoke_obese_projections %>% 
  filter(type_order == 1) %>% 
  filter(year <= 2005)
women_smoke <- smoke_obese_projections %>% 
  filter(type_order == 2) %>% 
  filter(year <= 2005)
men_65_smoke <- smoke_obese_projections %>% 
  filter(type_order == 3) %>% 
  filter(year <= 2005)
women_65_smoke <- smoke_obese_projections %>% 
  filter(type_order == 4) %>% 
  filter(year <= 2005)

male_birth_smoke_ets <- ets(men_smoke$smoke_rate[1:19])
men_smoke[20:24,2] <- as.data.frame(forecast(male_birth_smoke_ets, h = 5))[,1]

female_birth_smoke_ets <- ets(women_smoke$smoke_rate[1:19])
women_smoke[20:24,2] <- as.data.frame(forecast(female_birth_smoke_ets, h = 5))[,1]

male_65_smoke_ets <- ets(men_65_smoke$smoke_rate[1:19])
men_65_smoke[20:24,2] <- as.data.frame(forecast(male_65_smoke_ets, h = 5))[,1]

female_65_smoke_ets <- ets(women_65_smoke$smoke_rate[1:19])
women_65_smoke[20:24,2] <- as.data.frame(forecast(female_65_smoke_ets, h = 5))[,1]

male_birth_obese_ets <- ets(men_smoke$obesity_rate[1:19])
men_smoke[20:2425:29,3] <- as.data.frame(forecast(male_birth_obese_ets, h = 5))[,1]

female_birth_obese_ets <- ets(women_smoke$obesity_rate[1:19])
women_smoke[20:24,3] <- as.data.frame(forecast(female_birth_obese_ets, h = 5))[,1]

male_65_obese_ets <- ets(men_65_smoke$obesity_rate[1:19])
men_65_smoke[20:24,3] <- as.data.frame(forecast(male_65_obese_ets, h = 5))[,1]

female_65_obese_ets <- ets(women_65_smoke$obesity_rate[1:19])
women_65_smoke[20:24,3] <- as.data.frame(forecast(female_65_obese_ets, h = 5))[,1]

men_smoke <- as.matrix(men_smoke)
women_smoke <- as.matrix(women_smoke)
men_65_smoke <- as.matrix(men_65_smoke)
women_65_smoke <- as.matrix(women_65_smoke)

smoke_obese_projections_filled <- as.data.frame(rbind(men_smoke[,2:3], women_smoke[,2:3], men_65_smoke[,2:3], women_65_smoke[,2:3]))
```

```{r arima_xreg_2000_2005}
male_birth_fit <- auto.arima(male_birth$ex[1:19], xreg=men_smoke[1:19,2:3])
male_birth_arima_xreg <- as.data.frame(forecast(male_birth_fit, h = 5, xreg=men_smoke[20:24,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_birth_arima_xreg <- male_birth_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 19), .before = 1)

female_birth_fit <- auto.arima(female_birth$ex[1:19], xreg=women_smoke[1:19,2:3])
female_birth_arima_xreg <- as.data.frame(forecast(female_birth_fit, h = 5, xreg=women_smoke[20:24,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_birth_arima_xreg <- female_birth_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 19), .before = 1)

male_65_fit <- auto.arima(male_65$ex[1:19], xreg=men_65_smoke[1:19,2:3])
male_65_arima_xreg <- as.data.frame(forecast(male_65_fit, h = 5, xreg=men_65_smoke[20:24,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
male_65_arima_xreg <- male_65_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 19), .before = 1)

female_65_fit <- auto.arima(female_65$ex[1:19], xreg=women_65_smoke[1:19,2:3])
female_65_arima_xreg <- as.data.frame(forecast(female_65_fit, h = 5, xreg=women_65_smoke[20:24,2:3])) %>% 
  select(`Point Forecast`, `Lo 95`, `Hi 95`)
female_65_arima_xreg <- female_65_arima_xreg %>% 
  add_row(`Point Forecast` = rep(NA, 19), .before = 1)

arima_forecasts_xreg <- rbind(male_birth_arima_xreg, female_birth_arima_xreg, male_65_arima_xreg, female_65_arima_xreg)
colnames(arima_forecasts_xreg) <- c('point_arima_xreg', 'lo95_arima_xreg', 'hi95_arima_xreg')

obs.df_2000 <- bind_cols(obs.df_2000,arima_forecasts_xreg)
```

```{r add_observed_2000}
post_2000_observed <- obs.df.future %>%
  select(year, ex) %>% 
  filter(year %in% 2001:2005) %>% 
  add_row(year = 1982:2000, .before = 1) %>% 
  add_row(year = 1982:2000, .before = 25) %>% 
  add_row(year = 1982:2000, .before = 49) %>% 
  add_row(year = 1982:2000, .before = 73) %>% 
  select(ex)
colnames(post_2000_observed) <- "observed"

obs.df_2000 <- bind_cols(obs.df_2000, post_2000_observed)

ssa_projections_2005 <- read_csv('2001_trustees_report_projections.csv')[1:20,1:5] %>% 
  add_row(year = 1982:2000, type_order = 1, .before = 1) %>% 
  add_row(year = 1982:2000, type_order = 2, .before = 25) %>% 
  add_row(year = 1982:2000, type_order = 3, .before = 49) %>% 
  add_row(year = 1982:2000, type_order = 4, .before = 73) %>% 
  select(ssa_projection, lower_bound, upper_bound)

obs.df_2000 <- bind_cols(obs.df_2000, ssa_projections_2005)
```

```{r 2000_plot}
obs.plots.all.2000 <- obs.df_2000 %>%
  mutate(fit = ifelse(year <= 2000, NA, fit),
         lwr = ifelse(year <= 2000, NA, lwr),
         upr = ifelse(year <= 2000, NA, upr))%>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Pre-2000 Model Performances for the Years 2001-2005") + geom_line(aes(y=fit), color = "lightseagreen") + geom_line(aes(y=point_arima_xreg), color = "darkorange3") + geom_point(aes(y=ssa_projection), color = "gray40") + geom_point(aes(y = observed)) + geom_ribbon(aes(ymin=lwr, ymax=upr), alpha=0.1, fill = "lightseagreen") + geom_ribbon(aes(ymin=lo95_arima_xreg, ymax=hi95_arima_xreg), alpha=0.1, fill = "darkorange3") + geom_errorbar(aes(ymin=lower_bound, ymax=upper_bound), alpha=0.5, fill = "gray40")

ggsave(filename='figures/systematic/graphics-pred_all_2000-bw-1.pdf', plot=obs.plots.all.2000, height=8, width=8)
```

```{r 2005_plot}
obs.plots.all.2005 <- obs.df_2005 %>%
  mutate(fit = ifelse(year <= 2005, NA, fit),
         lwr = ifelse(year <= 2005, NA, lwr),
         upr = ifelse(year <= 2005, NA, upr))%>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous(NULL) + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Pre-2005 Model Performances for the Years 2006-2010") + geom_line(aes(y=fit), color = "lightseagreen") + geom_line(aes(y=point_arima_xreg), color = "darkorange3") + geom_point(aes(y=ssa_projection), color = "gray40") + geom_point(aes(y = observed)) + geom_ribbon(aes(ymin=lwr, ymax=upr), alpha=0.1, fill = "lightseagreen") + geom_ribbon(aes(ymin=lo95_arima_xreg, ymax=hi95_arima_xreg), alpha=0.1, fill = "darkorange3") + geom_errorbar(aes(ymin=lower_bound, ymax=upper_bound), alpha=0.5, fill = "gray40")

ggsave(filename='figures/systematic/graphics-pred_all_2005-bw-1.pdf', plot=obs.plots.all.2005, height=8, width=8)
```

```{r hmd_v_ssa_plot}
hmd_v_ssa_use <- ex.use %>%
  mutate(type = paste0(sex, age, sep = "")) %>% 
  mutate(type = case_when(type == 'Female0' ~ "Female Life Expectancy at Birth",
                          type == 'Female65' ~"Female Life Expectancy at 65",
                          type == 'Male0' ~"Male Life Expectancy at Birth",
                          type == 'Male65'~"Male Life Expectancy at 65"))
hmd_v_ssa_use$type= factor(hmd_v_ssa_use$type, levels=c("Male Life Expectancy at Birth",
                                                        "Female Life Expectancy at Birth",
                                                        "Male Life Expectancy at 65",
                                                        "Female Life Expectancy at 65"))

hmd_v_ssa <- hmd_v_ssa_use %>% 
  ggplot(aes(x=forecast.year, y=hmd_observed)) + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Data Discrepencies Between HMD and SSA Observed Life Expectancies") + geom_line(aes(y=hmd_observed), color = "mediumvioletred") + geom_line(aes(y=ssa_observed), color = "gray48") + theme(plot.title = element_text(size = 15))

ggsave(filename='figures/systematic/graphics-hmd_v_ssa-bw-1.pdf', plot=hmd_v_ssa, height=8, width=8)
```


```{r all_non_linear_univariates}
obs.plots.all.nonlinear <- obs.df.future %>%
  mutate(fit = ifelse(year <= 2010, NA, fit)) %>% 
  ggplot(aes(x=year, y=ex)) + geom_point(color="gray19") + scale_x_continuous("Year") + scale_y_continuous("Life Expectancy (Years)") + facet_wrap(~type, nrow=3, ncol=2, scales="free") + expand_limits(x=1980) + geom_path(color="gray19") + theme(legend.position="none", strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Observed Period Life Expectancy and Nonlinear Univariate Model Performances")+ geom_line(aes(y=yhat), color = "deepskyblue2") + geom_line(aes(y=point_ets), color = "palegreen4") + geom_line(aes(y=point_arima), color = "red4") + geom_point(aes(y = observed)) + theme(plot.title = element_text(size = 14))

ggsave(filename='figures/systematic/graphics-pred_all_nonlinear-bw-1.pdf', plot=obs.plots.all.nonlinear, height=8, width=8)
```












%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% 2010 and 2005 LE Forecasts      %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage

\subsection{2010 and 2005 Life Expectancy Forecasts}

\begin{figure}[h!]
\caption{Forecast Error of Life Expectancy in 2010 by Year of Trustees Report. Circles
    (females) and triangles (males) colored white when truth falls
    within SSA uncertainty intervals and colored black when the truth falls
    outside SSA uncertainty intervals.}\label{2010resid-bw}
```{r 2010-resid-by-tr-bw,out.width='\\linewidth',custom.plot=TRUE, fig.keep='all', fig.ext='pdf',echo=FALSE}
ex.use$agelabel <- "Life Expectancy at Birth"
ex.use[ex.use$age==65,]$agelabel <- "Life Expectancy at 65"
ex.use$agelabel <- factor(ex.use$agelabel, levels=c("Life Expectancy at Birth","Life Expectancy at 65"))

resid2010 <- ggplot(data=ex.use[ex.use$forecast.year==2010,], aes(x=TR, y=hmd_residual)) + geom_path(aes(group=sex), color="gray19", alpha=0.5) + geom_hline(yintercept=0,linetype="solid",color="ivory4") + geom_point(size=4, aes(shape=interaction(sex,hmd_coverage),fill=as.factor(hmd_coverage)),color="gray19", alpha=0.9) + scale_x_continuous("Year of Trustees Report", limits=c(1980,2010)) + scale_y_continuous("Forecast Error (Years)", limits=c(-3,1.75)) + scale_shape_manual(values=c(19,17,21,24)) + scale_fill_manual(values=c("gray19","white"))  + facet_wrap(~agelabel) + theme(legend.position="none",strip.background = element_rect(fill="snow1"), text=element_text(size=15, color="black")) + ggtitle("Forecast Error of Life Expectancy in 2010 by Year of Report")
resid2010.labeldf <- data.frame(agelabel=c("Life Expectancy at Birth","Life Expectancy at Birth","Life Expectancy at 65","Life Expectancy at 65"), sex=c("Male","Female","Male","Female"), x=rep(1982,4), y=c(-1.5,1,-2.2,1.5))
resid2010 <- resid2010 + geom_text(data=resid2010.labeldf, aes(x=x,y=y,label=sex), color="gray19", family=ff) 

ggsave(filename='figures/systematic/graphics-2010-resid-by-tr-bw-1.pdf', plot=resid2010, height=4, width=8)
```
\end{figure}


\begin{figure}[h!]
\caption{Forecast Error of Life Expectancy in 2005 by Year of Trustees Report. Circles
    (females) and triangles (males) colored white when truth falls
    within SSA uncertainty intervals and colored black when the truth falls
    outside SSA uncertainty intervals.}\label{2005resid-bw}
```{r 2005-resid-by-tr-bw,out.width='\\linewidth',custom.plot=TRUE, fig.keep='all', fig.ext='pdf',echo=FALSE}
resid2005 <- ggplot(data=ex.use[ex.use$forecast.year==2005,], aes(x=TR, y=hmd_residual)) + geom_path(aes(group=sex), color="gray19", alpha=0.5) + geom_hline(yintercept=0,linetype="solid",color="ivory4") + geom_point(size=4, aes(shape=interaction(sex,hmd_coverage),fill=as.factor(hmd_coverage)),color="gray19", alpha=0.9) + scale_x_continuous("Year of Trustees Report", limits=c(1980,2010)) + scale_y_continuous("Forecast Error (Years)", limits=c(-3,1.75)) + theme(legend.position="none",strip.background = element_rect(fill="snow1"),text=element_text(size=15, color="black")) + scale_shape_manual(values=c(19,17,21,24)) + scale_fill_manual(values=c("gray19","white")) + facet_wrap(~agelabel) + ggtitle("Forecast Error of Life Expectancy in 2005 by Year of Report")
resid2005.labeldf <- data.frame(agelabel=c("Life Expectancy at Birth","Life Expectancy at Birth","Life Expectancy at 65","Life Expectancy at 65"), sex=c("Male","Female","Male","Female"), x=rep(1982,4), y=c(-1,0.75,-1.5,0.75))
resid2005 <- resid2005 + geom_text(data= resid2005.labeldf, aes(x=x,y=y,label=sex), color="gray19", family=ff) 

ggsave(filename='figures/systematic/graphics-2005-resid-by-tr-bw-1.pdf', plot=resid2005, height=5, width=8)
```
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% CI Coverage          %%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\subsection{Uncertainty Intervals}

\begin{figure}[h!]
\caption{Uncertainty interval coverage by year of
    Trustees Report and year of forecast. Black indicates uncertainty
    interval covered the truth, white indicates that it did not, and
    gray ``X'' indicates that SSA did not provide an uncertainty
    interval. Contemporaneous forecast error is possible because of
    the time lag (typically three to four years) in finalizing
    mortality data.}\label{coverage-bw}
```{r ci-coverage-bw,out.width='\\linewidth',custom.plot=TRUE, fig.keep='all', fig.ext='pdf',echo=FALSE}

# create data frame
ex.coverage <- ex.use[,c("TR","forecast.year","hmd_coverage")]
ex.coverage$type <- NA
ex.coverage$type[ex.use$age==0 & ex.use$sex=="Male"] <- "Male Life Expectancy at Birth"
ex.coverage$type[ex.use$age==0 & ex.use$sex=="Female"] <- "Female Life Expectancy at Birth"
ex.coverage$type[ex.use$age==65 & ex.use$sex=="Male"] <- "Male Life Expectancy at 65"
ex.coverage$type[ex.use$age==65 & ex.use$sex=="Female"] <- "Female Life Expectancy at 65"
colnames(ex.coverage)[3] <- c("coverage")

# fill in 84-87 as NA
blanks.df <- as.data.frame(expand.grid(c(1984:1987),c(2005),c(NA),unique(ex.coverage $type)))
colnames(blanks.df) <- c("TR","forecast.year","coverage","type")

coverage.df <- rbind(ex.coverage,blanks.df)

# reorder factors
coverage.df$type_order <- 1
coverage.df$type_order[coverage.df$type=="Female Life Expectancy at Birth"] <- 2
coverage.df$type_order[coverage.df$type=="Male Life Expectancy at 65"] <- 3
coverage.df$type_order[coverage.df$type=="Female Life Expectancy at 65"] <- 4
coverage.df$type <- reorder(coverage.df$type, coverage.df$type_order)

coverage.plot <- ggplot(data=coverage.df, aes(x=TR, y=forecast.year, fill=as.factor(coverage))) + geom_tile(color="black") + scale_x_continuous("Year of Trustees Report") + scale_y_continuous("Year Forecast") + scale_fill_manual("CI Covers Truth?",values=c("gray30","white"), na.value="gray90") + theme(legend.position="none", strip.background = element_rect(fill="snow1"),text=element_text(size=15, color="black"))  + facet_wrap(~type, nrow=3, ncol=) + expand_limits(x=1980) + geom_segment(aes(x=1983.5, xend=1984.5, y=2002.5, yend=2007.5), color="gray50", size=0.1) + geom_segment(aes(x= 1984.5, xend= 1983.5, y= 2002.5, yend= 2007.5), color="gray50", size=0.1) + geom_segment(aes(x=1984.5, xend=1985.5, y=2002.5, yend=2007.5), color="gray50", size=0.1) + geom_segment(aes(x= 1985.5, xend= 1984.5, y= 2002.5, yend= 2007.5), color="gray50", size=0.1) + geom_segment(aes(x=1985.5, xend=1986.5, y=2002.5, yend=2007.5), color="gray50", size=0.1) + geom_segment(aes(x= 1986.5, xend= 1985.5, y= 2002.5, yend= 2007.5), color="gray50", size=0.1) + geom_segment(aes(x=1986.5, xend=1987.5, y=2002.5, yend=2007.5), color="gray50", size=0.1) + geom_segment(aes(x= 1987.5, xend= 1986.5, y= 2002.5, yend= 2007.5), color="gray50", size=0.1) + ggtitle("Uncertainty Interval Coverage")

ggsave(filename='figures/systematic/graphics-ci-coverage-bw-1.pdf', plot=coverage.plot, height=5, width=8)
```
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%% FINANCIALS %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Financial Forecasts}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%% UNANTICIPATED COSTS      %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Cost of Mortality Forecasting Errors}

\begin{figure}[h!]
\caption{Cost of Mortality Forecasting Errors (in
    billions of 2010 dollars). Each panel of the figure corresponds to
    a Trustees Report. Within each panel, we plot the forecast error
    in total Social Security expenditures (solid lines) and the forecast error
    in total Social Security expenditures due to
    mortality forecasting errors (dashed lines). Finally, we represent
    the Great Recession as a vertical grey region.}\label{unanticip-costs-bw}
```{r unanticip_costs-bw,out.width='\\linewidth',custom.plot=TRUE, fig.keep='all', fig.ext='pdf',echo=FALSE}
# calculate average annual OASI benefit payments
avg.benefit.payment <- expend_obs %>% 
  mutate(payment = oasi_benif_payments*1000000/oasi_total_benif) %>% 
  select(year, payment)
colnames(avg.benefit.payment)[1] <- 'TR'
 
# convert to 2010 constant dollars
CPI_2010 <- as.numeric(expend_obs[expend_obs$year==2010,"CPI.U"])
expend_obs <- expend_obs %>% 
  mutate(correction_to_2010 = (CPI_2010)/CPI.U)
avg.benefit.payment$payment <- avg.benefit.payment$payment*expend_obs$correction_to_2010

# calculate unanticipated costs due to demography
unanticip_cost <- right_join(ub, avg.benefit.payment[1:11,], by = 'TR')
unanticip_cost_df <- unanticip_cost %>% 
  mutate(cost = unexpect_benif*payment) %>% 
  select(TR, forecast.year, cost)
# unanticip_cost <- t(apply(ub,1, function(x) x*avg.benefit.payment$payment[1:11]))
# unanticip_cost_df <- melt(unanticip_cost)
colnames(unanticip_cost_df) <- c("TR","year.forecast","cost")
unanticip_cost_df$cost <- unanticip_cost_df$cost/1000000000

expend_obs <- expend_obs %>% 
  select(-correction_to_2010)

# merge forecast expenditures with actual expenditures
expend_forecasts <- merge(expend_forecasts,expend_obs, by.x="year.forecast",by.y="year",all.x=TRUE)

expend_forecasts <- expend_forecasts %>% 
  mutate(correction_to_2010 = (CPI_2010)/CPI.U)

# calculate residuals in total forecast expenditures and convert to constant 2010 dollars
expend_forecasts$resid <- (expend_forecasts$oasdi.total.cost - expend_forecasts$oasdi_total_expend/1000)* expend_forecasts$correction_to_2010

# merge total unanticipated costs and unanticipated costs to demography into one data frame
unanticip_cost_df <- merge(unanticip_cost_df, expend_forecasts[,c("TR","year.forecast","resid")], by=c("TR","year.forecast"), all.x=T)

# data frame for labels
label_df <- data.frame(TR=c(2001,2001), x=c(2005,2005), y=c(20,-2), label=c("Total","Due to Mortality"))

unanticip_plot <- ggplot(data=unanticip_cost_df[unanticip_cost_df$TR>2000 & unanticip_cost_df$TR<2009,],aes(year.forecast,cost)) + geom_rect(aes(xmin=2008, xmax=2009.5, ymin=-Inf, ymax=Inf), fill="gray80") + geom_point(size=2,color="black") + geom_line(size=0.8,color="black", linetype="dotted") + facet_wrap(~TR, nrow=2) + scale_y_continuous("Errors in Total Expenditures (Billions of 2010 Dollars)") + scale_x_continuous("Year Forecast", limits=c(2001,2010), breaks=c(2002,2004,2006,2008,2010)) + geom_line(aes(year.forecast, abs(resid)),color="black",size=0.8) + geom_point(aes(year.forecast, abs(resid)),color="black",size=2) + theme(strip.background = element_rect(fill="snow1"),axis.text.x=element_text(angle=45),text=element_text(size=15, color="black")) + geom_text(data= label_df, aes(x=x, y=y, label=label), size=4.5, family=ff) + ggtitle("Cost of Mortality Forecasting Errors")

ggsave(filename='figures/systematic/graphics-unanticip_costs-bw-1.pdf', plot=unanticip_plot, height=8, width=8)
```
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%% COST   %%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\subsection{Cost Rate Forecasting Errors}


\begin{figure}[h!]
\caption{Cost Rate Forecasting Errors. Forecast errors
    in the cost rate (vertically) by the year of the forecast
    (horizontally) by how many years into the future the forecast is
    made (in the title of each panel). Cost rate forecasting errors
    are overestimates if positive and underestimates if
    negative. Points are white if the error is within SSA's
    uncertainty interval and black otherwise.}\label{cost-by-tr-bw}
```{r cost_resid_lattice-bw,fig.ext='pdf',custom.plot=TRUE,out.width='\\linewidth',fig.keep='all', echo=FALSE}
tf.balance.pred$cost.residual <- tf.balance.pred$cost.rate - tf.balance.pred$cost.truth
tf.balance.pred$years.from.forecast <- tf.balance.pred$forecast.year-tf.balance.pred$TR
cost.coverage <- tf.balance.pred$cost.lower <= tf.balance.pred$cost.truth & tf.balance.pred$cost.upper >= tf.balance.pred$cost.truth
tf.balance.pred$cost.coverage <- cost.coverage

cost_plot <- ggplot(tf.balance.pred[tf.balance.pred$forecast.year<=2012 & tf.balance.pred$years.from.forecast<=10 & tf.balance.pred$years.from.forecast>0,], aes(TR,cost.residual)) + geom_hline(yintercept=0,linetype="dotted",color="ivory4")  + geom_smooth(stat="smooth", method="loess",color="black", span=0.9, fill="grey") + geom_point(size=2, color="gray20", alpha=0.75) + geom_point(aes(color=cost.coverage),na.rm=FALSE, size=1.5)  + scale_x_continuous("Year of Trustees Report") + scale_y_continuous("Cost Rate Forecast Error (Percentage Points)") + facet_wrap(~years.from.forecast, nrow=2, ncol=5) + theme(legend.position="none", strip.background = element_rect(fill="snow1"), axis.text.x=element_text(angle=45),text=element_text(size=15, color="black")) + scale_color_manual(values=c("gray20","white"),na.value="darkgrey") + ggtitle("Cost Rate Forecasting Errors")

ggsave(filename='figures/systematic/graphics-cost_resid_lattice-bw-1.pdf', plot=cost_plot, height=8, width=8)
```
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%% BALANCE   %%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\subsection{Trust Fund Balance Forecasting Errors}

\begin{figure}[h!]
\caption{Balance Forecasting Errors. Forecast
    errors in balance (vertically) by the year of the forecast
    (horizontally) by how many years into the future the forecast is
    made (in the title of each panel). Positive errors overestimate Trust
    Fund assets; negative errors underestimate them. Points are white
    if the error is within SSA's uncertainty interval and black
    otherwise.}\label{balance-by-tr-bw}
```{r balance_resid_lattice-bw,fig.ext='pdf',custom.plot=TRUE,out.width='\\linewidth',fig.keep='all', echo=FALSE}
tf.balance.pred$balance.residual <- tf.balance.pred$balance - tf.balance.pred$balance.truth
tf.balance.pred$years.from.forecast <- tf.balance.pred$forecast.year-tf.balance.pred$TR
balance.coverage <- tf.balance.pred$balance.lower <= tf.balance.pred$balance.truth & tf.balance.pred$balance.upper >= tf.balance.pred$balance.truth
tf.balance.pred$balance.coverage <- balance.coverage

balance_plot <- ggplot(tf.balance.pred[tf.balance.pred$forecast.year<=2012 & tf.balance.pred$years.from.forecast<=10 & tf.balance.pred$years.from.forecast>=1,], aes(TR,balance.residual)) + geom_hline(yintercept=0,linetype="dotted",color="ivory4")  + geom_smooth(stat="smooth", method="loess",color="black", span=0.9, fill="grey") + geom_point(size=2, color="gray20", alpha=0.75) + geom_point(aes(color= balance.coverage),na.rm=FALSE, size=1.5) + scale_x_continuous("Year of Trustees Report") + scale_y_continuous("Fund Balance Forecast Error (Percentage Points)") + facet_wrap(~years.from.forecast, nrow=2, ncol=5) + theme(legend.position="none", strip.background = element_rect(fill="snow1"), axis.text.x=element_text(angle=45),text=element_text(size=15, color="black")) + scale_color_manual(values=c("gray20","white"),na.value="darkgrey") + ggtitle("Trust Fund Balance Forecasting Errors")

ggsave(filename='figures/systematic/graphics-balance_resid_lattice-bw-1.pdf', plot=balance_plot, height=8, width=8)
```
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%% TF RATIO  %%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\subsection{Trust Fund Ratio Forecasting Errors}


\begin{figure}[h!]
\caption{Trust Fund Ratio Forecasting Errors.
    Forecast errors in the trust fund ratio (vertically) by the year
    of the Trustees Report forecast (horizontally) by how many years
    into the future the forecast is made (in the title of each panel).
    Positive errors overestimate Trust Fund assets; negative errors
    underestimate them. Points are white if 3the error is within SSA's
    uncertainty interval and black otherwise.}\label{ratio-by-tr-bw}
```{r ratio_resid_lattice-bw,fig.ext='pdf',custom.plot=TRUE,out.width='\\linewidth',fig.keep='all', echo=FALSE}
tf.ratio.pred$residual <- tf.ratio.pred$tfratio - tf.ratio.pred$tfratio.truth
tf.ratio.pred <- tf.ratio.pred[order(tf.ratio.pred$TR, tf.ratio.pred$forecast.year),]
tf.ratio.pred$years.from.forecast <- tf.ratio.pred$forecast.year-tf.ratio.pred$TR
tf.ratio.pred$coverage <- tf.ratio.pred$tfratio.lower <= tf.ratio.pred$tfratio.truth & tf.ratio.pred$tfratio.upper >= tf.ratio.pred$tfratio.truth

tfratio_plot <- ggplot(tf.ratio.pred[tf.ratio.pred$forecast.year<=2012 & tf.ratio.pred$years.from.forecast<=10 & tf.ratio.pred$years.from.forecast>=1,], aes(TR,residual)) + geom_hline(yintercept=0,linetype="dotted",color="ivory4")  + geom_smooth(stat="smooth", method="loess",color="black", span=0.9, fill="grey") + geom_point(size=2, color="gray20", alpha=0.75) + geom_point(aes(color=coverage),na.rm=FALSE, size=1.5) + scale_x_continuous("Year of Trustees Report") + scale_y_continuous("Forecast Error (Percentage Points)") + facet_wrap(~years.from.forecast, nrow=2) + theme(legend.position="none", strip.background = element_rect(fill="snow1"), axis.text.x=element_text(angle=45),text=element_text(size=15, color="black"))  + scale_color_manual(values=c("gray20","white"),na.value="darkgrey") + ggtitle("Trust Fund Ratio Forecasting Errors")

ggsave(filename='figures/systematic/graphics-ratio_resid_lattice-bw-1.pdf', plot=tfratio_plot, height=8, width=8)
```
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\end{document}



